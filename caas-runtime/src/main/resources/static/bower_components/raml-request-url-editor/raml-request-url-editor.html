<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input-container.html">
<link rel="import" href="../paper-input/paper-input-behavior.html">
<link rel="import" href="../paper-input/paper-input-error.html">
<link rel="import" href="../iron-form-element-behavior/iron-form-element-behavior.html">
<link rel="import" href="../iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../markdown-styles/markdown-styles.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../iron-input/iron-input.html">

<!--
`<raml-request-url-editor>` An URL editor for the RAML request panel

Use this input element to provide URI variables support.
If the `uriParameters` array is set, and the user click on the variable name
then the documentation for this variable will be displayed.
This behavior can be turned off by setting `skip-docs` attribute (or `skipDocs`
property).

The element has custom validation. If the value contains a variable string
("{some string}") then it will display a validation error.

### Example
```html
<raml-request-url-editor auto-validate required></raml-request-url-editor>
```
```javascript
var input = document.querySelector('raml-request-url-editor');
input.addEventListener('value-changed', function(e) {
  if (input.validate())
    var url = e.detail.value;
});
```

When the `value` of this control change then the `url-value-changed` event will
be fired. Also, if other element or the application will send this event then
the value of this form control will be updated. This is a way to update URL
value without directly accessing the element.

```jsvascript
document.dispatchEvent(new CustomEvent('url-value-changed', {
  bubbles: true,
  detail: {
    value: 'http://www.domain.com'
  }
}));
```

Firing this event will update the value to `http://www.domain.com`.

### Styling
`<raml-request-url-editor>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--raml-request-url-editor` | Mixin applied to the element | `{}`
`--raml-request-url-editor-documentation` | Mixin applied to the documentation field. Not that this node has the `--arc-font-body1` mixin and also `markdown-styles` applies. | `{}`

Additionally use styles defined for the `paper-input` element.

@group RAML Elements
@element raml-request-url-editor
@demo demo/index.html
-->
<dom-module id="raml-request-url-editor">
  <template>
    <style include="markdown-styles"></style>
    <style>
    :host {
      outline: none;
      display: block;
      @apply(--raml-request-url-editor);
    }
    .markdown-body {
      @apply(--arc-font-body1);
      margin-top: 12px;
      color: rgba(0, 0, 0, 0.54);
      @apply(--raml-request-url-editor-documentation);
    }
    .paper-input-input {
      @apply(--raml-request-url-editor-input);
    }
    </style>
    <paper-input-container
      no-label-float="[[noLabelFloat]]"
      attr-for-value="bind-value"
      always-float-label="[[alwaysFloatLabel]]"
      disabled$="[[disabled]]"
      invalid="[[invalid]]">
      <label hidden$="[[!label]]">[[label]]</label>
      <input is="iron-input"
        id="input"
        class="paper-input-input"
        aria-label-prefix="[[_ariaLabelledBy]]"
        bind-value="{{value}}"
        disabled$="[[disabled]]"
        required$="[[required]]"
        autofocus$="[[autofocus]]"
        readonly$="[[readonly]]"
        type="url"
        on-tap="_inputTap"
        on-blur="_onElementBlur"/>
      <template is="dom-if" if="[[errorMessage]]">
        <paper-input-error>[[errorMessage]]</paper-input-error>
      </template>
    </paper-input-container>
    <template is="dom-if" if="[[documentation]]">
      <marked-element markdown="[[documentation]]">
        <div class="markdown-html markdown-body"></div>
      </marked-element>
    </template>
  </template>
  <script>
  Polymer({
    is: 'raml-request-url-editor',

    behaviors: [
      Polymer.PaperInputBehavior,
      Polymer.IronValidatableBehavior,
      Polymer.IronFormElementBehavior
    ],

    /**
     * Fired when the URL value change.
     * Note that this event is fifed before validation occur and therefore the URL may be invalid.
     *
     * @event url-value-changed
     * @param {String} value The URL.
     */

    properties: {
      // A list of RAML defined URI parameters
      uriParameters: Array,
      // A RAML defined absolute URL for this endpoint. It may contain variables
      url: {
        type: String,
        observer: '_onUrlChanged'
      },
      /**
       * The label for this input.
       */
      label: {
        type: String,
        value: 'Request URL'
      },
      // A value generated by this editor - the URL.
      value: {
        type: String,
        notify: true,
        observer: '_onValueChanged'
      },
      errorMessage: {
        type: String,
        value: 'Fill the URI parameters before making a request'
      },
      // A documentation to show.
      documentation: {
        type: String
      },
      // If true it will not display documentation for the variable (if available).
      skipDocs: Boolean,
      /**
       * If set and the `url` property change and the `url` value is a relative
       * url then it prefix the `url` with this value to compute full URL.
       */
      baseUri: String
    },

    hostAttributes: {
      'tabindex': -1,
      focusable: true
    },

    observers: [
      '_computeAbsoliteUrl(baseUri, url)'
    ],

    ready: function() {
      this._ready = true;
      // If there's an initial input, validate it.
      if (this.value) {
        this._handleAutoValidate();
      }
    },

    attached: function() {
      this.listen(window, 'url-value-changed', '_extValueChangedHandler');
    },

    detached: function() {
      this.unlisten(window, 'url-value-changed', '_extValueChangedHandler');
    },

    /**
     * A handler that is called on input
     */
    _onValueChanged: function() {
      if (!this._ready) {
        return;
      }
      this.fire('url-value-changed', {
        value: this.value
      });
      this._handleAutoValidate();
    },

    /**
     * If called it mean that the method has changed. And possibly the url value.
     * If the old value id the same as the new value it means that the user switched a method
     * staying with the same andpoint. Therefore nothing needs to be done.
     */
    _onUrlChanged: function(value, oldValue) {
      if (value === oldValue && value !== undefined) {
        return;
      }
      if (this._isRelative(value) && this.baseUri) {
        return;
      }
      this.set('value', value);
    },

    _computeAbsoliteUrl: function(baseUri, url) {
      if (!this._isRelative(url) || !baseUri) {
        return;
      }
      var uri = this.baseUri;
      if (uri[uri.length - 1] !== '/') {
        uri += '/';
      }
      if (url[0] === '/') {
        url = url.substr(1);
      }
      this.set('value', uri + url);
    },
    /**
     * Determined if given URL is relative or absolute URL.
     * Note: It retrns `true` if the URL is empty.
     *
     * @param {String} url The URL to test
     * @return {Boolean} True if the URL is a relative URL.
     */
    _isRelative: function(url) {
      if (!url || typeof url !== 'string') {
        return true;
      }
      if (url.indexOf('http') !== 0) {
        return true;
      }
      return false;
    },

    // Displays the doc for the variable.
    _displayVariableDoc: function(id) {
      if (this.skipDocs) {
        return;
      }
      var up = this.uriParameters;
      if (!id || !up) {
        this.documentation = '';
        return;
      }
      var item;
      for (var i = 0, len = up.length; i < len; i++) {
        if (up[i].name === id) {
          item = up[i];
          break;
        }
      }
      if (!item || !item.description) {
        this.documentation = '';
        return;
      }
      this.documentation = item.description;
    },

    _onElementBlur: function() {
      this.documentation = '';
    },

    /**
     * A handler for the `url-value-changed` event.
     * If this element is not the source of the event then it will update the `value` property.
     * It's to be used besides the Polymer's data binding system.
     */
    _extValueChangedHandler: function(e) {
      if (e.target === this) {
        return;
      }
      this.set('value', e.detail.value);
    },

    _getValidity: function() {
      var value = this.value;
      if (!this.required && !value) {
        return true;
      }

      if (value === undefined) {
        return true;
      }

      if (!value && this.required) {
        return false;
      }

      if (!value) {
        return true;
      }

      if (value.indexOf('{') !== -1 && value.indexOf('}') !== -1) {
        return false;
      }

      if ('URL' in window) {
        try {
          new URL(value);
          return true;
        } catch (e) {
          return false;
        }
      }
      return this.$.input.validity.valid;
    },
    // Handler for input click / tap.
    _inputTap: function() {
      var variable = this._getSelectedVariable();
      this._displayVariableDoc(variable);
    },
    /**
     * Returns variable name for current caret position.
     * This can be used for mouse on keyboard events to determine
     * if current action involve a variable.
     * It takes a selection start as a orientation point to find a variable.
     *
     * @return {String|undefined} Variable name or undefined if at current
     * position there's no variable.
     */
    _getSelectedVariable: function() {
      var start = this.$.input.selectionStart;
      var variable = this._computeVariableFromPosition(start);
      return variable;
    },
    /**
     * Computes variable from current caret position.
     * It looks for brackets to the left and right from the selection and
     * everything between is a variable name.
     *
     * @param {Number} start Caret position in thex field.
     * @return {String|undefined} Variable name or undefined if at current
     * position there's no variable.
     */
    _computeVariableFromPosition: function(start) {
      var value = this.value;
      if (!start || !value) {
        return;
      }
      // Check existance of the left bracket "{".
      var pos;
      var leftBracketPos = -1;
      for (pos = start; pos > 0; pos--) {
        if (value[pos] === '}') {
          break;
        }
        if (value[pos] === '{') {
          leftBracketPos = pos;
          break;
        }
      }
      if (leftBracketPos === -1) {
        // Click is not in the vartiable.
        return;
      }
      var rightBracketPos = -1;
      for (pos = leftBracketPos; pos < value.length; pos++) {
        var _val = value[pos];
        if (_val === '}') {
          rightBracketPos = pos;
          break;
        } else if (_val === '.' || _val === '/') {
          break;
        }
      }
      if (rightBracketPos === -1) {
        return;
      }
      var variable = value.substr(leftBracketPos + 1,
        rightBracketPos - leftBracketPos - 1);
      return variable;
    }
  });
  </script>
</dom-module>
